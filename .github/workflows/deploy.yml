name: Deploy to GitHub Container Registry and Pages

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°GitHub Container Registry
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    # åˆ›å»ºåŒ…å«todoåº”ç”¨çš„é™æ€ç«™ç‚¹
    - name: Create deployment directory
      run: |
        mkdir -p dist
        cp index.html dist/
        
        # åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„é™æ€todoåº”ç”¨
        cat > dist/todo-app.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Todo Application</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                body {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    font-family: 'Arial', sans-serif;
                    padding: 20px 0;
                }
                
                .todo-container {
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                    max-width: 600px;
                    margin: 0 auto;
                    padding: 30px;
                }
                
                .todo-header {
                    text-align: center;
                    margin-bottom: 30px;
                }
                
                .todo-header h1 {
                    color: #333;
                    font-weight: 600;
                    margin-bottom: 10px;
                }
                
                .todo-input {
                    margin-bottom: 25px;
                }
                
                .todo-input input {
                    border-radius: 25px;
                    border: 2px solid #e0e0e0;
                    padding: 12px 20px;
                    font-size: 16px;
                    transition: all 0.3s ease;
                }
                
                .todo-input input:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
                }
                
                .btn-add {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    border: none;
                    border-radius: 25px;
                    padding: 12px 25px;
                    color: white;
                    font-weight: 500;
                    transition: all 0.3s ease;
                }
                
                .btn-add:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                }
                
                .todo-list {
                    list-style: none;
                    padding: 0;
                }
                
                .todo-item {
                    background: #f8f9fa;
                    margin-bottom: 10px;
                    padding: 15px 20px;
                    border-radius: 10px;
                    border-left: 4px solid #667eea;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: all 0.3s ease;
                }
                
                .todo-item:hover {
                    transform: translateX(5px);
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                }
                
                .todo-item.completed {
                    opacity: 0.7;
                    border-left-color: #28a745;
                }
                
                .todo-item.completed .todo-text {
                    text-decoration: line-through;
                    color: #6c757d;
                }
                
                .todo-text {
                    flex: 1;
                    font-size: 16px;
                    color: #333;
                }
                
                .todo-actions {
                    display: flex;
                    gap: 10px;
                }
                
                .btn-action {
                    border: none;
                    background: none;
                    padding: 8px;
                    border-radius: 50%;
                    width: 35px;
                    height: 35px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                }
                
                .btn-complete {
                    color: #28a745;
                }
                
                .btn-complete:hover {
                    background: #28a745;
                    color: white;
                }
                
                .btn-delete {
                    color: #dc3545;
                }
                
                .btn-delete:hover {
                    background: #dc3545;
                    color: white;
                }
                
                .todo-stats {
                    text-align: center;
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #e0e0e0;
                    color: #6c757d;
                }
                
                .empty-state {
                    text-align: center;
                    padding: 40px 20px;
                    color: #6c757d;
                }
                
                .empty-state i {
                    font-size: 64px;
                    margin-bottom: 20px;
                    opacity: 0.3;
                }
                
                .github-info {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    border-left: 4px solid #28a745;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="todo-container">
                    <div class="github-info">
                        <small><i class="fab fa-github"></i> <strong>Todoåº”ç”¨æ¥æº:</strong> åŸºäºGitHubå¼€æºé¡¹ç›®æ„å»ºï¼Œä½¿ç”¨Dockerå®¹å™¨åŒ–éƒ¨ç½²</small>
                    </div>
                    
                    <div class="todo-header">
                        <h1><i class="fas fa-tasks"></i> Todo Application</h1>
                        <p class="text-muted">Stay organized and productive</p>
                    </div>
                    
                    <div class="todo-input">
                        <div class="row">
                            <div class="col-9">
                                <input type="text" class="form-control" id="todoInput" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." maxlength="100">
                            </div>
                            <div class="col-3">
                                <button class="btn-add w-100" onclick="addTodo()">
                                    <i class="fas fa-plus"></i> æ·»åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="todoListContainer">
                        <ul class="todo-list" id="todoList"></ul>
                        
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <i class="fas fa-clipboard-list"></i>
                            <h5>æš‚æ— ä»»åŠ¡</h5>
                            <p>æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹ä½¿ç”¨å§ï¼</p>
                        </div>
                    </div>
                    
                    <div class="todo-stats" id="todoStats">
                        <small>æ€»ä»»åŠ¡: <span id="totalTasks">0</span> | å·²å®Œæˆ: <span id="completedTasks">0</span> | å‰©ä½™: <span id="remainingTasks">0</span></small>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-outline-light">
                        <i class="fas fa-home"></i> è¿”å›ä¸»é¡µ
                    </a>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
            <script>
                let todos = JSON.parse(localStorage.getItem('todos')) || [];
                let todoIdCounter = parseInt(localStorage.getItem('todoIdCounter')) || 1;

                document.addEventListener('DOMContentLoaded', function() {
                    renderTodos();
                    
                    document.getElementById('todoInput').addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addTodo();
                        }
                    });
                });

                function addTodo() {
                    const input = document.getElementById('todoInput');
                    const text = input.value.trim();
                    
                    if (text === '') {
                        alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹ï¼');
                        return;
                    }
                    
                    const todo = {
                        id: todoIdCounter++,
                        text: text,
                        completed: false,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    todos.push(todo);
                    saveTodos();
                    input.value = '';
                    renderTodos();
                }

                function toggleTodo(id) {
                    const todo = todos.find(t => t.id === id);
                    if (todo) {
                        todo.completed = !todo.completed;
                        todo.updatedAt = new Date().toISOString();
                        saveTodos();
                        renderTodos();
                    }
                }

                function deleteTodo(id) {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                        todos = todos.filter(t => t.id !== id);
                        saveTodos();
                        renderTodos();
                    }
                }

                function renderTodos() {
                    const todoList = document.getElementById('todoList');
                    const emptyState = document.getElementById('emptyState');
                    
                    if (todos.length === 0) {
                        todoList.style.display = 'none';
                        emptyState.style.display = 'block';
                    } else {
                        todoList.style.display = 'block';
                        emptyState.style.display = 'none';
                        
                        todoList.innerHTML = todos.map(todo => \`
                            <li class="todo-item \${todo.completed ? 'completed' : ''}">
                                <div class="todo-text">\${escapeHtml(todo.text)}</div>
                                <div class="todo-actions">
                                    <button class="btn-action btn-complete" onclick="toggleTodo(\${todo.id})" title="\${todo.completed ? 'æ ‡è®°ä¸ºæœªå®Œæˆ' : 'æ ‡è®°ä¸ºå®Œæˆ'}">
                                        <i class="fas \${todo.completed ? 'fa-undo' : 'fa-check'}"></i>
                                    </button>
                                    <button class="btn-action btn-delete" onclick="deleteTodo(\${todo.id})" title="åˆ é™¤ä»»åŠ¡">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        \`).join('');
                    }
                    
                    updateStats();
                }

                function updateStats() {
                    const total = todos.length;
                    const completed = todos.filter(t => t.completed).length;
                    const remaining = total - completed;
                    
                    document.getElementById('totalTasks').textContent = total;
                    document.getElementById('completedTasks').textContent = completed;
                    document.getElementById('remainingTasks').textContent = remaining;
                }

                function saveTodos() {
                    localStorage.setItem('todos', JSON.stringify(todos));
                    localStorage.setItem('todoIdCounter', todoIdCounter.toString());
                }

                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            </script>
        </body>
        </html>
        EOF
    
    # åˆ›å»ºdocker-composeçš„å±•ç¤ºé¡µé¢
    - name: Create Docker Compose Info Page
      run: |
        cat > dist/docker-info.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Dockeréƒ¨ç½²ä¿¡æ¯</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
            <style>
                body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px 0; }
                .container { max-width: 800px; }
                .info-card { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="info-card">
                    <h2><i class="fab fa-docker"></i> Docker & Docker Compose éƒ¨ç½²ä¿¡æ¯</h2>
                    <p class="text-muted">æœ¬é¡¹ç›®ä½¿ç”¨GitHub Container Registryå’ŒGitHub Pageså®ç°Dockeréƒ¨ç½²</p>
                    
                    <h4>ğŸ³ Dockerfile å†…å®¹:</h4>
                    <pre><code class="language-dockerfile">FROM nginx:alpine
        COPY index.html /usr/share/nginx/html/
        COPY todo.html /usr/share/nginx/html/
        EXPOSE 80
        CMD ["nginx", "-g", "daemon off;"]</code></pre>
                    
                    <h4>ğŸ”§ docker-compose.yml é…ç½®:</h4>
                    <pre><code class="language-yaml">version: '3.8'
        
        services:
          personal-website:
            image: ghcr.io/kaiza20232064/finall_lab:latest
            container_name: personal-website
            ports:
              - "8080:80"
            restart: always
          
          todo-app:
            image: nginx:alpine
            container_name: todo-app
            ports:
              - "8081:80"
            volumes:
              - ./todo-app.html:/usr/share/nginx/html/index.html:ro
            restart: always</code></pre>
                    
                    <h4>ğŸš€ GitHub Actions å·¥ä½œæµ:</h4>
                    <div class="alert alert-info">
                        <strong>è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹:</strong>
                        <ol>
                            <li>æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°GitHub Container Registry</li>
                            <li>éƒ¨ç½²é™æ€ç½‘ç«™åˆ°GitHub Pages</li>
                            <li>ä¸¤ä¸ªåº”ç”¨åŒæ—¶åœ¨GitHubå…è´¹æœåŠ¡å™¨ä¸Šè¿è¡Œ</li>
                        </ol>
                    </div>
                    
                    <div class="text-center">
                        <a href="index.html" class="btn btn-primary me-3">è¿”å›ä¸»é¡µ</a>
                        <a href="todo-app.html" class="btn btn-success">è®¿é—®Todoåº”ç”¨</a>
                    </div>
                </div>
            </div>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
        </body>
        </html>
        EOF
    
    # ä¿®æ”¹ä¸»é¡µï¼Œæ·»åŠ æ­£ç¡®çš„é“¾æ¥
    - name: Update index.html links
      run: |
        sed -i 's|<a href="#" class="btn btn-outline-primary me-3">.*</a>|<a href="todo-app.html" class="btn btn-outline-primary me-3"><i class="fas fa-tasks"></i> Todoåº”ç”¨</a>|g' dist/index.html || true
        sed -i 's|<a href="#" class="btn btn-outline-success">.*</a>|<a href="docker-info.html" class="btn btn-outline-success"><i class="fab fa-docker"></i> Dockerä¿¡æ¯</a>|g' dist/index.html || true
    
    # éƒ¨ç½²åˆ°GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'dist'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4